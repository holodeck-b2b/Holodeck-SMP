<!-- 
 * Copyright (C) 2025 The Holodeck B2B Team
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the Affero GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 -->
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/smd-layout}"
	  >
<body>
<section layout:fragment="smd-content">
	<form id="smtForm" method="post" th:action="@{/smd/smt/update}" th:object="${smt}">
	<div class="row">
	<div class="container">
		<h5 th:text="(*{id} ? 'Edit' : 'Add') + ' Service Metadata Template'">Edit Service Metadata Template</h5>
		<div class="card">
		<div class="card-header">
			General
		</div>
		<div class="card-body">
			<div class="row mb-3">
				<label for="inputIdScheme" class="col-sm-3 col-form-label">Service</label>
				<div class="col-sm-7">
					<select id="transportProfile" class="form-select" th:field="*{service}"
							th:errorclass="is-invalid">
						<option value="" selected>Select service to use for this template</option>
						<option th:each="s : ${allServices}" th:value="${s.oid}" th:text="${s.name}" th:title="${s.id.value}">Select service</option>
					</select>
					<div th:if="${#fields.hasErrors('service')}" th:errors="*{service}"
						id="invalidServiceMsg" class="invalid-feedback"></div>
				</div>
			</div>
			<div class="row mb-3" th:if="${apiEnabled}">
				<label for="inputName" class="col-sm-3 col-form-label">Template ID</label>
				<div class="col-sm-7">
				<input type="text" class="form-control" readonly
					th:value="*{oid > 0 ? oid : 'A default template ID will be generated'}" >
				</div>
			</div>
			<div class="row mb-3">
				<label for="inputName" class="col-sm-3 col-form-label">Name</label>
				<div class="col-sm-7">
				<input type="text" class="form-control" id="inputName" th:field="*{name}"
					   placeHolder="If not set, will default to Service name">
				</div>
			</div>
		</div>
		</div>
		<div class="card">
		<div class="card-header">
			<div class="row align-items-center">
				<div class="col col-md-auto">Processes and endpoints</div>
				<div class="col"><button type="submit" name="addProcGroup" value="22"
						class="btn btn-sm btn-outline-primary">Add process group</button></div>
			</div>
		</div>
		<div class="card-body" style="overflow-y: scroll; max-height: 50vh">
		<div th:if="${#fields.hasErrors('processMetadata')}" class="row mb-3">
			<span class="fs-6 invalid-feedback" style="display: block" th:errors="*{processMetadata}"></span>
		</div>
		<div class="accordion" id="pgAccordion">
		<div th:each="pg, pgStat : *{processMetadata}" class="accordion-item">
			<span class="accordion-header f2-text" th:id="|heading_${pgStat.index}|">
			  <span class="accordion-button" type="button" data-bs-toggle="collapse"
					  th:data-bs-target="|#collapse_${pgStat.index}|" 
					  >Process Group #[(${pgStat.index + 1})]
			  </span>
			</span>
			<div th:id="|collapse_${pgStat.index}|" class="accordion-collapse collapse show"
				 data-bs-parent="#pgAccordion">
			<div class="accordion-body">
			<div class="row">
				<div class="col-8 mr-5">
					<table id="procList" class="table " >
						<thead>
						<tr>
							<th>Process</th>
							<th>Participant role(s)</th>
							<th></th>
						</tr>
						</thead>
						<tbody >
						<tr th:each="p, pStat : ${pg.processInfo}">
							<td>
								<span th:if="${!p.processId.isNoProcess()}" th:text="${p.process.name}" th:title="${p.processId.value}"></span>
								<span th:if="${p.processId.isNoProcess()}">«No process»</span>
							</td>
							<td>
								<div th:each="r : ${p.roles}">
									<span th:text="${r.value}"></span><br/>
								</div>
							</td/>
							<td>
								<a href="#" onclick="submitForm(this);" name="editProcessInfo" th:value="|${pgStat.index},${pStat.index}|" style="margin-right: 0.25em"><i class="bi bi-pencil-square"></i></a>
								<a href="#" onclick="submitForm(this);" name="removeProcessInfo" th:value="|${pgStat.index},${pStat.index}|"><i class="bi bi-x-circle text-danger"></i></a>
							</td>
						</tr>
						</tbody>
					</table>
					<div class="d-grid col-4 d-md-block row justify-content-center mx-auto ">
						<button type='submit' name="addProcessInfo" th:value="${pgStat.index}" class="btn btn-sm btn-outline-primary">Add process</button>
					</div>
				</div>
				<div class="col-4">
					<div th:if="${#fields.hasErrors('processMetadata[__${{pgStat.index}}__]')}" th:errors="*{processMetadata[__${{pgStat.index}}__]}"
						 class="invalid-feedback" style="display: unset">Invalid endpoint/redirection</div>
					<table id="epList" class="table" >
					<thead>
					<tr>
						<th >Used endpoints/redirection</th>
					</tr>
					</thead>
					<tbody>
						<tr th:each="ep, epStat : ${pg.endpoints}">
							<td th:text="${ep.name}" th:title="${ep.url}">Default AS4 endpoint </td>
							<td><a href="#" onclick="submitForm(this);" name="removeEndpoint" th:value="|${pgStat.index},${epStat.index}|"><i class="bi bi-x-circle text-danger"></i></a></td>
						</tr>
						<tr th:if="${pg.redirection}">
							<td><i class="bi bi-arrow-right-square"></i>
								<span th:text="${pg.redirection.newSMPURL}">https://another.smp.server/togoto/</span>
							</td>
							<td>
								<a href="#" onclick="submitForm(this);" name="editRedirect" th:value="${pgStat.index}" style="margin-right: 0.25em"><i class="bi bi-pencil-square"></i></a>
								<a href="#" onclick="submitForm(this);" name="removeRedirect" th:value="${pgStat.index}"><i class="bi bi-x-circle text-danger"></i></a>
							</td>
						</tr>
					</tbody>
					</table>
					<div class="row justify-content-center mt-2 ">
						<div class="col-auto"><button th:disabled="${pg.redirection} != null"
								name="addEndpoint" th:value="${pgStat.index}"
								type='submit' class="btn btn-sm btn-outline-primary">Add endpoint</button></div>
						<div class="col-auto"><button th:disabled="not (${pg.endpoints.isEmpty()} and ${pg.redirection} == null)"
								name="addRedirect" th:value="${pgStat.index}"
								type="submit" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#confirmCancel">Add redirection</button></div>
					</div>
				  </div>
			  </div>
			  <div th:unless="*{processMetadata.size() == 1}" class="row d-grid col-4 d-md-block justify-content-center mt-3 mx-auto ">
				  <button class="btn btn-sm btn-outline-danger" style="margin-left: 1em"
						onclick="confirmRemoveGroup(event);" data-confirm-title="Confirm process group removal"
						data-confirm-question="Are you sure you want to remove this process group?"
						data-confirm-button="Remove"
						name="removeProcGroup" th:value="${pgStat.index}">Remove this group</span>

			  </div>
			</div>
			</div>
		</div>
		</div>
		</div>
		</div>
	</div>
	<div class="row justify-content-center mt-3">
		<div class="col-auto "><button type='submit' class="btn btn-primary">Save service metadata template</button></div>
		<div class="col-auto "><button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#confirmDialog">Cancel update</button></div>
	</div>
	</div>
	</form>
	<script>
		function submitForm(b) {
			$('<input />').attr('type', 'hidden')
						   .attr('name', $(b).attr("name"))
						   .attr('value', $(b).attr("value"))
						   .appendTo('#smtForm');
			$("#smtForm").submit();
		}

		function confirmRemoveGroup(e) {
			e.preventDefault();
			e.stopPropagation();
			var b = e.target;
			var confirmDlg = $('#confirmDialog');
			$('#title', confirmDlg).text($(b).attr("data-confirm-title"));
			$('#question', confirmDlg).text($(b).attr("data-confirm-question"));
			$('#confirmBtn', confirmDlg).text($(b).attr("data-confirm-button"));
			$('#confirmBtn', confirmDlg).on('click', function(e) { e.preventDefault(); e.stopPropagation(); submitForm(b); });

			bootstrap.Modal.getOrCreateInstance(confirmDlg).show();
		}
	</script>

	<div th:if="${procinfo}">
		<div th:replace="fragments/pg_dialogs :: procInfoDialog"></div>
		<script>
			bootstrap.Modal.getOrCreateInstance($('#procInfoDialog')).show();
		</script>
	</div>
	<div th:if="${endpoint}">
		<div th:replace="fragments/pg_dialogs :: endpointDialog"></div>
		<script>
			bootstrap.Modal.getOrCreateInstance($('#epAddDialog')).show();
		</script>
	</div>
	<div th:if="${redirection}">
		<div th:replace="fragments/pg_dialogs :: redirectDialog"></div>
		<script>
			bootstrap.Modal.getOrCreateInstance($('#redirectDialog')).show();
		</script>
	</div>

	<div class="modal fade" id="confirmDialog" tabindex="-1" aria-labelledby="gridModalLabel" style="display: none;" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<span id="title" class="modal-title">Cancel update?</span>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p id="question">Are you sure you want to discard all updates made to the endpoint registration ?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go back</button>
					<a th:href="@{/smd/smt}" id="confirmBtn" class="btn btn-danger">Discard changes</a>
				</div>
			</div>
		</div>
	</div>

</section>
</body>
</html>
